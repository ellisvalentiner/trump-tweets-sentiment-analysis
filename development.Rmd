---
title: "development"
author: "Ellis Valentiner"
date: "2017-01-29"
output: html_document
---

```{r Preamble, include=FALSE}
suppressPackageStartupMessages(library(dplyr))
library(tidyr)
library(purrr)
library(twitteR)
library(tidytext)
library(magrittr)
library(stringr)
library(lubridate)
library(plotly)

knitr::opts_chunk$set(echo = TRUE)
```

```{r Setup, include=FALSE}
setup_twitter_oauth(Sys.getenv("twitter_consumer_key"),
                    Sys.getenv("twitter_consumer_secret"),
                    Sys.getenv("twitter_access_token"),
                    Sys.getenv("twitter_access_token_secret"))
```

```{r AFINN, include=FALSE}
afinn <- sentiments %>%
  filter(lexicon == "AFINN") %>%
  dplyr::select(word, score)
```

```{r Fetch tweets, include=FALSE}
trump_tweets <- userTimeline("realDonaldTrump", n = 3200)

n <- TRUE
while (n){
    minID <- trump_tweets %>%
        map_df(as.data.frame) %>%
        tbl_df() %>%
        summarize(id = min(id)) %>% 
        extract2("id")
    
    newTweets <- userTimeline("realDonaldTrump", n = 3200, maxID = minID)
    if (length(newTweets)==0){
        n <- FALSE
    } else {
        trump_tweets <- append(trump_tweets, newTweets)
    }
}

trump_tweets_df <- trump_tweets %>%
    map_df(as.data.frame) %>%
    tbl_df()
```

```{r Isolate tweets by Trump himself, include=FALSE}
tweets <- trump_tweets_df %>%
    filter(str_detect(statusSource, "Android")) %>%
    select(id, text, created)
```

```{r, include=FALSE}
reg <- "([^A-Za-z\\d#@']|'(?![A-Za-z\\d#@]))"
tweet_words <- tweets %>%
  filter(!str_detect(text, '^"')) %>%
  unnest_tokens(output = word,
                input = text,
                token = "regex",
                pattern = reg) %>%
  filter(!word %in% stop_words$word,
         str_detect(word, "[a-z]"))
```

```{r Assign tweet sentiment rating, include=FALSE}
tweet_sentiments <- tweet_words %>%
    mutate(
        created = date(created)
    ) %>%
    inner_join(get_sentiments("afinn"), by = "word") %>%
    group_by(created, id) %>%
    summarize(
        score = mean(score)
    ) %>%
    group_by(created) %>%
    summarise(
        score = median(score)
    )
```

```{r Plot 1, echo=FALSE}
tweet_sentiments %>%
    mutate(
        mvg_avg = zoo::rollmean(score, k = 7, na.pad = TRUE, align = "right") %>% zoo::na.fill("extend")
    ) %>%
    ggplot() +
    geom_line(aes(x=created, y=score), color = "grey") +
    geom_line(aes(x=created, y=mvg_avg), color = "orange", size = 1.25) +
    geom_point(aes(x=created, y=score)) +
    scale_x_date("Tweet Date", date_breaks = "1 month", date_labels = "%b%y") +
    scale_y_continuous("Sentiment Score", limits = c(-4, 4)) +
    theme_bw()
ggplotly()
```

